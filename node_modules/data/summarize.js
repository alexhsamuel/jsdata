(function () {
  const typedArray = require('data/typed-array')

  const SUMMARY = Symbol('summary')

  /**
   * Computes a summary of an array of floating point values.
   *
   * Returns an object with these keys:
   *
   *  - `len`: the array length
   *  - `numFinite`: the number of finite (not NaN or infinity) values
   *  - `numNan`: the number of NaN values
   *  - `sum`: the sum of finite values (computed in order)
   *  - `sum2`: the sum of squares of finite values (computed in order)
   *  - `prec10`: the number of decimal digits required to render the 
   *    significant fractional part of the value; subsequent digits are 0
   */
  function summarizeFloat(arr) {
    let min
    let max
    const len = arr.length
    let numFinite = 0
    let numNaN = 0
    let sum = 0
    let sum2 = 0
    let prec10 = 0
    let scale10 = 1
    const prec10Max = arr instanceof Float32Array ? 8 : 16
    const eps = 2 * (arr instanceof Float32Array ? 5.96e-8 : 1.1e-16)

    for (let i = 0; i < len; ++i) {
      const val = arr[i]
      if (Number.isFinite(val)) {
        if (numFinite === 0) {
          numFinite = 1
          min = max = val
        }
        else {
          numFinite += 1
          if (val < min) min = val
          if (val > max) max = val
        }
        sum += val
        sum2 += val * val

        if (val !== 0) 
          while (prec10 < prec10Max) {
            const scaled = Math.abs(val) * scale10
            let diff = scaled - Math.trunc(scaled)
            if (diff > 0.5) diff = 1 - diff
            if (diff / scaled < eps) break
            else {
              prec10 = prec10 + 1
              scale10 = scale10 * 10
            }
          }
      }
      else if (isNaN(val)) numNaN += 1
    }

    return {len, numFinite, numNaN, min, max, sum, sum2, prec10}
  }

  function summarizeInt(arr) {
    let min = null
    let max = null
    const len = arr.length
    let sum = 0
    let sum2 = 0

    for (let i = 0; i < len; ++i) {
      const val = arr[i]
      if (min === null) min = max = val
      else if (val < min) min = val
      else if (val > max) max = val
      sum += val
      sum2 += val * val
    }

    return {len, numFinite: len, numNaN: 0, min, max, sum, sum2}
  }

  function summarizeString(arr) {
    const len = arr.length
    let minLength = null
    let maxLength = null

    for (let i = 0; i < len; ++i) {
      const val = arr[i].toString()
      const length = val.length
      if (minLength === null) minLength = maxLength = length
      else if (length < minLength) minLength = length
      else if (length > maxLength) maxLength = length
    }

    return {len, minLength, maxLength}
  }

  module.exports = function (arr) {
    const cached = arr[SUMMARY]
    if (cached) return cached
    else return arr[SUMMARY] = (
        typedArray.isFloatArray(arr) ? summarizeFloat(arr)
      : typedArray.isIntArray(arr) ? summarizeInt(arr)
      : summarizeString(arr)
    )
  }

}).call(this)
