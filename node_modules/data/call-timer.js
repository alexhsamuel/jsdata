(function () {
  const _ = require('underscore')
  const _now = require('performance-now')

  const MSEC = 1E-3
  const now = () => _now() * MSEC

  /**
   * Times invocation of zero-argument `fn`.
   *
   * @return
   *   An array of the runtime in sec and the return value.
   */
  function time(fn, count=1) {
    const start = now()
    for (let i = 0; i < count; ++i) fn()
    const end = now()
    return end - start
  }

  function estimateTime(fn, minTime=MSEC) {
    for (let count = 1;; count *= 10) {
      const elapsed = time(fn, count)
      if (elapsed > minTime) return elapsed / count
    }
  }

  function rawTimer({target=1, trials=8}={}) {
    return function (fn, ...args) {
      const call = () => fn(...args)

      const estimate = estimateTime(call)
      const count = Math.max(1, Math.round(target / trials / estimate))

      return _(trials).times(() => time(call, count) / count)
    }
  }

  function timer(timerArgs={}) {
    const rawTimer = this.rawTimer(timerArgs)
    const {percentile=[0.05, 0.10, 0.15]} = timerArgs

    return function (fn, ...args) {
      const name = fn.name
      const times = rawTimer(fn, ...args)

      const sorted = times.sort()
      const num = sorted.length
      const getPct = p => sorted[Math.round(num * p)]
      const [pct_lo, pct, pct_hi] = percentile
      const time = getPct(pct)
      const timeErr = getPct(pct_hi) - getPct(pct_lo)
      const size = args.length > 0 ? args[0].length : 0
      const totalSize = args.reduce((s, a) => s + (a.length || 0), 0)

      return {
        function: name,
        size: size,
        totalSize: totalSize,
        trials: num,
        time: time,
        timeErr: timeErr
      }
    }
  }

  function formatTime(time) {
    if (time < 500E-9) return (time / 1E-9).toFixed(1) + ' ns'
    else if (time < 500E-6) return (time / 1E-6).toFixed(1) + ' Âµs'
    else if (time < 500E-3) return (time / 1E-3).toFixed(1) + ' ms'
    else return time.toFixed(2) + ' s'
  }

  function format({size, trials, time}=times) {
    return formatTime(time) + ' = ' + (size / time).toFixed(0) + ' /sec in '
      + trials + ' trials'
  }

  module.exports = {
    MSEC: 1E-3,
    USEC: 1E-6,
    NSEC: 1E-9,
    
    timer: timer,
    rawTimer: rawTimer,
    now: now,
    time: time,
    format: format,
  }

}).call(this)


