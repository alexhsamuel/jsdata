(function () {
  const assert = require('assert')
  const summarize = require('data/summarize')
  const typedArray = require('data/typed-array')

  function maxStringLength(arr) {
    let max = 0
    for (let i = 0; i < arr.length; ++i) {
      const len = (arr[i] || '').toString().length
      if (len > max) max = len
    }
    return max
  }

  function getNumDigits(value) {
    assert(value >= 0)
    return value === 0 ? 1 
      : Math.max(Math.floor(Math.log10(value) + 1), 1)
  }

  module.exports = {
    pad(string, width, pad=' ', position=1) {
      string = string || ''
      assert(0 <= position && position <= 1)
      if (string.length < width) {
        const total = width - string.length
        const left = Math.round((1 - position) * total)
        return pad.repeat(left) + string + pad.repeat(total - left)
      }
      else return string
    },

    elide(string, width, ellipsis='\u2026', position=1) {
      const len = string.length
      if (len <= width) return string
      else {
        const keep = width - ellipsis.length
        const left = Math.round(position * keep)
        return string.slice(0, left) + ellipsis + string.slice(len - keep + left)
      }
    },

    palide(string, width, ellipsis='\u2026', pad=' ', elidePosition=1, padPosition=1) {
      string = string || ''
      return (
          string.length < width ? this.pad(string, width, pad, padPosition)
        : string.length > width ? this.elide(string, width, ellipsis, elidePosition)
        : string
      )
    },

    formatter(width, precision=null) {
      const len = precision === null ? width : width + precision + 1
      const fmt = num => {
        if (Number.isFinite(num)) {
          if (precision !== null)
            num = num.toFixed(precision)
          num = num.toString()
          const point = num.lastIndexOf('.')
          if (num.length < len)
            num = ' '.repeat(len - num.length) + num
          return num
        }
        else if (num) {
          const ret = num.toString()
          return ret + ' '.repeat(Math.max(0, len - ret.length))
        }
        else
          return ' '.repeat(len)
      }
      fmt.width = len
      return fmt
    },

    guess(arr) {
      formatter = module.exports.formatter
      const summary = summarize(arr)

      if (typedArray.isIntArray(arr)) {
        const signed = summary.min < 0
        const width = (
          getNumDigits(
            Math.max(Math.abs(summary.min), Math.abs(summary.max)))
          + (signed ? 1 : 0)
        )
        return formatter(width)
      }
      else if (typedArray.isFloatArray(arr)) {
        const signed = summary.min < 0

        const width = (
          getNumDigits(
            Math.trunc(Math.max(Math.abs(summary.min), Math.abs(summary.max))))
          + (signed ? 1 : 0)
        )
        return formatter(width, summary.prec10)
      }
      else return formatter(summary.maxLength)
    },

  }

}).call(this)
